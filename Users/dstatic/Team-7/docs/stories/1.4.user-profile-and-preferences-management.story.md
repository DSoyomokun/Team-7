# Story 1.4: User Profile and Preferences Management

**Epic**: Core Financial Management System Completion  
**Story ID**: 1.4  
**Priority**: High  
**Estimated Effort**: 2-3 days  
**Assigned To**: Backend Developer  

## User Story

**As a young adult user,**  
I want to manage my profile settings and preferences,  
so that I can customize the app to match my needs and currency preferences.

## Acceptance Criteria

### Backend Implementation (Current Focus)
1. **User Profile Model Enhancement**
   - User model includes profile fields: full_name, currency_preference
   - Profile data is properly validated and sanitized
   - Profile updates sync with existing Supabase authentication

2. **Database Schema & Migration**
   - User profile table is created or extended with profile fields
   - Currency preference defaults to 'USD'
   - Profile data maintains referential integrity with auth system

3. **API Endpoints**
   - `GET /api/users/profile` - Fetch current user's profile and preferences
   - `PUT /api/users/profile` - Update user's profile information
   - `GET /api/users/preferences` - Get user preferences (currency, etc.)
   - `PUT /api/users/preferences` - Update user preferences

4. **Business Logic & Validation**
   - Profile updates sync with Supabase auth user data
   - Currency preference validation (supported currencies)
   - Profile data loads properly on authentication
   - Proper error handling for profile operations

5. **Integration Requirements**
   - Profile updates work with existing Supabase auth user data
   - Currency preferences are stored and can be retrieved for frontend formatting
   - Profile data maintains consistency with authentication system

## Technical Requirements

### Data Model
```typescript
interface UserProfile {
  id: string;
  user_id: string;
  full_name: string | null;
  currency_preference: string; // default: 'USD'
  created_at: Date;
  updated_at: Date;
}

interface UserPreferences {
  currency_preference: string;
  // Future: other preferences can be added here
}
```

### API Endpoints
- **Get Profile**: `GET /api/users/profile`
  - Response: `{ full_name: string, currency_preference: string, email: string }`

- **Update Profile**: `PUT /api/users/profile`
  - Body: `{ full_name?: string, currency_preference?: string }`
  - Response: Updated profile object

- **Get Preferences**: `GET /api/users/preferences`
  - Response: `{ currency_preference: string }`

- **Update Preferences**: `PUT /api/users/preferences`
  - Body: `{ currency_preference?: string }`
  - Response: Updated preferences object

### Database Changes
- Create or extend user profile table with profile fields
- Add currency_preference column with default 'USD'
- Ensure proper foreign key relationship with auth users

### Supported Currencies
- USD (default)
- EUR
- GBP
- CAD
- AUD
- JPY
- CHF
- Other common currencies as needed

## Definition of Done

- [x] User profile model is implemented and tested
- [x] Database schema is updated with proper migrations
- [x] All API endpoints are implemented and functional
- [x] Profile updates sync with Supabase authentication
- [x] Currency preference validation is implemented
- [x] Profile data loads properly on authentication
- [x] Unit tests cover all profile operations
- [x] Integration tests verify auth-profile relationships
- [ ] API documentation is updated
- [ ] Code review is completed

## Notes

- This story focuses on backend implementation only
- Frontend integration will be handled in a separate story
- Ensure backward compatibility with existing user data
- Profile updates must not break existing authentication flows

## Dependencies

- Story 1.1 (Foundation Data Models) - for basic model patterns
- Existing Supabase authentication system
- Existing user management patterns

## Risk Assessment

- **Low Risk**: Standard CRUD operations for profile data
- **Medium Risk**: Syncing profile updates with Supabase auth
- **Mitigation**: Thorough testing of auth-profile synchronization

## Status
Ready for Review

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | SM Agent |

## Dev Agent Record

### Tasks Completed
- [x] Enhanced User model with UserProfile and UserPreferences interfaces
- [x] Updated UserRepository to handle profile table operations
- [x] Implemented comprehensive UserService with all required methods
- [x] Added validation middleware for profile and preferences updates
- [x] Enhanced AuthService to create profile records on user registration
- [x] Added user routes to main router configuration
- [x] Created comprehensive test suites for all components

### Implementation Details
- **Model Enhancement**: Added UserProfile interface with user_id, full_name, currency_preference
- **Database Integration**: Profile table already existed, corrected table name references
- **API Endpoints**: All required endpoints implemented with proper validation
- **Business Logic**: Currency validation, profile-auth synchronization, error handling
- **Testing**: 22 test cases covering repository, service, validation, and API layers
- **Integration**: Profile creation on user signup, auth-profile data merging

### Files Modified/Created
- `src/models/User.ts` - Enhanced with profile interfaces and currency constants
- `src/repositories/user.repository.ts` - Updated for profile table operations
- `src/services/user_service.ts` - Complete rewrite with all profile functionality
- `src/services/auth_service.ts` - Added profile creation on signup
- `src/middleware/validation.ts` - Added profile and preferences validation
- `src/routes/users.ts` - Applied validation middleware
- `src/routes/index.ts` - Added user routes
- `src/__tests__/user-profile.test.ts` - API and service integration tests
- `src/__tests__/user-repository.test.ts` - Repository unit tests
- `src/__tests__/validation.test.ts` - Validation middleware tests

### Debug Log References
No major issues encountered. Minor type fixing in auth service for full_name field.

### Completion Notes
- All acceptance criteria met
- Profile system fully integrated with Supabase auth
- Comprehensive validation and error handling
- Full test coverage with 22 passing tests
- Ready for code review

## QA Results
*This section will be populated by the QA agent during review* 